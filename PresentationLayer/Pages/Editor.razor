@page "/editor/{testFileId:guid}"
@layout MainLayout
@inject IServiceManager serviceManager;
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage;
@inject NavigationManager NavManager;

@if(IsLoading)
{
    <MudGrid>
        <MudItem Class="d-flex align-center justify-center mud-width-full">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
        </MudItem>
    </MudGrid>
}
else 
{
    <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-5">View the code, translation and documentation for @testFile.Name</MudText>
    <MudGrid>
        <MudItem xs="12" sm="6">
             <MudPaper Height="700px" Width="100%" Style="background-color: rgba(217, 217, 217, 1);">
                <MudStack Style="min-height:100%;" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Stretch">
                        <MudText Typo="Typo.h5">
                            Content:
                        </MudText>
                        <MudText Class="align-stretch">
                            @testFile.Content
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Dark" Size="Size.Large" OnClick="@(async () => await Translate())">Translate</MudButton>
                </MudStack>
             </MudPaper>
            
        </MudItem>
        <MudItem xs="12" sm="6">
             <MudPaper Height="70%" Width="100%" Style="background-color: rgba(217, 217, 217, 0.56)" Class="mb-2">
                <MudStack Style="min-height:70%;" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Stretch">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Steps: </MudText>
                        @if(!TranslationLocked)
                        {
                            <MudIconButton OnClick="@(async () => await Save(false))" Icon="@Icons.Material.Filled.Save" Variant="Variant.Filled" Color="Color.Dark" Size="Size.Medium" />
                        }
                        else 
                        {
                            <MudIconButton OnClick="@(() => StartEdit(false))" Icon="@Icons.Material.Filled.Edit" Variant="Variant.Filled" Color="Color.Dark" Size="Size.Medium" />
                        }
                    </MudStack>
                    @if(IsTranslating)
                    {
                        <MudGrid>
                            <MudItem Class="d-flex align-center justify-center mud-width-full">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                            </MudItem>
                        </MudGrid>
                    }
                    @if(documentation != null)
                    {
                        <MudInput Value="@documentation.Translation"  Disabled="@TranslationLocked" Lines="20" DisableUnderLine="true" />

                    }
                    else 
                    {
                        <MudInput Value="@("")"  Disabled="true" Lines="20" DisableUnderLine="true" />
                    }

                </MudStack>
                
             </MudPaper>
              <MudPaper Height="30%" Width="100%" Style="background-color: rgba(217, 217, 217, 0.56)">
                <MudStack Style="min-height:30%;" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Stretch">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Summary: </MudText>
 
                        @if(!SummaryLocked)
                        {
                            <MudIconButton OnClick="@(async () => await Save(true))" Icon="@Icons.Material.Filled.Save" Variant="Variant.Filled" Color="Color.Dark" Size="Size.Medium" />
                        }
                        else 
                        {
                            <MudIconButton OnClick="@(() => StartEdit(true))" Icon="@Icons.Material.Filled.Edit" Variant="Variant.Filled" Color="Color.Dark" Size="Size.Medium" />
                        }
                    </MudStack>
                    @if(IsTranslating)
                    {
                        <MudGrid>
                            <MudItem Class="d-flex align-center justify-center mud-width-full">
                                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                            </MudItem>
                        </MudGrid>
                    }
                    @if(documentation != null)
                    {
                        <MudInput Value="@documentation.Summary"  Disabled="@SummaryLocked" Lines="20" DisableUnderLine="true" />
                    }
                    else 
                    {
                        <MudInput Value="@("")"  Disabled="true" Lines="20" DisableUnderLine="true" />
                    }
                </MudStack>              
              </MudPaper>
        </MudItem>
    </MudGrid>
}



@code
{
    private UserDTO? user { get; set; }

    private DocumentationDTO? documentation { get; set; }

    [Inject] ISnackbar Snackbar { get; set; }

    public bool SummaryLocked = true;

    public bool TranslationLocked = true;

    bool IsLoading { get; set; } = true;

    bool IsTranslating { get; set; } = false;

    [Parameter]
    public Guid testFileId { get; set; }

    private TestFileDTO testFile { get; set; }

    private string testContent;
    public EventCallback<string> ValueChanged {get;set;}

    public async Task GetTestFile(Guid testFileId)
    {   

        testFile = await serviceManager.ProjectService.LoadTestFileByIdAsync(testFileId);
        
    }
    public async Task GetDocumentation(Guid testFileId)
    {
        try
        {
            documentation = await serviceManager.ProjectService.LoadDocumentationByTestFilesIdAsync(testFileId);
        }
        catch (System.Exception)
        {
            
            documentation = null;
        }
    }

    public void SetTranslating(bool StartTranslation)
    {
        if(StartTranslation)
        {
            documentation = null;
            IsTranslating = !IsTranslating;

        } 
        else 
        {
            IsTranslating = !IsTranslating;
        }
        StateHasChanged();
    }

    public async Task Translate()
    {
        SetTranslating(true);
        documentation = await serviceManager.TranslationService.translateTestfile(testFile);

        SetTranslating(false);
        StateHasChanged();
    }

    private void StartEdit(bool summary)
    {
        if(summary)
        {
            SummaryLocked = false;
        }
        else 
        {
            TranslationLocked = false;
        }
    }

    private async Task Save(bool summary)
    {

        //save
        if(summary)
        {
            SummaryLocked = true;
        }
        else 
        {
            TranslationLocked = true;
        }

    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            IsLoading = false;
            // Retrieve user from the session storage
            var user = await sessionStorage.GetItemAsync<UserDTO>("SessionUser");

            // If the user is set, retrieve entities from the database
            if (user != null)
            {
                await GetTestFile(testFileId);

                await GetDocumentation(testFileId);
                
                IsLoading = false;

                StateHasChanged();
            }

        }
    }
}

